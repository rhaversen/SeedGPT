name: CI/CD

on:
    push:
        branches: ["main"]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            -   name: Check out code
                uses: actions/checkout@v6

            -   name: Setup Node.js
                uses: actions/setup-node@v6
                with:
                    node-version: "lts/*"
                    cache: "npm"
                    cache-dependency-path: "**/package-lock.json"

            -   name: Install dependencies
                run: npm ci

            -   name: Build
                run: npm run build

            -   name: Coverage
                run: npm test -- --coverage --coverageProvider=v8 --coverageReporters=text --passWithNoTests

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Login to Docker Hub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKER_USERNAME }}
                    password: ${{ secrets.DOCKER_PASSWORD }}

            -   name: Build and push Docker image
                run: |
                    docker buildx create --use
                    docker buildx build --file Dockerfile --platform linux/arm64,linux/amd64 \
                      --push --tag ${{ secrets.DOCKER_USERNAME }}/seedgpt:${{ github.sha }} \
                      --tag ${{ secrets.DOCKER_USERNAME }}/seedgpt:latest .

            -   name: Stamp image tag in deployment.yaml
                run: sed -i "s/\${GITHUB_SHA}/${{ github.sha }}/g" DevOps/deployment.yaml

            -   name: Checkout DevOps repo
                uses: actions/checkout@v6
                with:
                    repository: "SeedGPT/DevOps"
                    token: ${{ secrets.DEVOPS_REPO_TOKEN }}
                    path: "DevOpsRepo"

            -   name: Push manifests to DevOps
                run: |
                    cp DevOps/* DevOpsRepo/
                    cd DevOpsRepo
                    git config user.name "GitHub Actions Bot"
                    git config user.email "actions@github.com"
                    git add .
                    if git diff --staged --quiet; then
                      echo "No changes to commit"
                    else
                      git commit -m "SeedGPT: ${{ github.sha }}"
                      git push origin HEAD
                    fi
